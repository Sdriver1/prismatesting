import SQL from "sql-template-strings";
import { db } from "../../startup/db.js";
import { does_currency_exist } from "./does_currency_exist.js";
import { get_currency_config } from "../configurers/currencies.js";
import * as Discord from "discord.js";
import * as levelups from "../../currency/operations/levelups.js";
import { client } from "../../startup/client.js";
import config from "../../configs/config.json" with { type: "json" };
import { extend_xp_boost, generate_xp_boost, } from "../configurers/xp_boosts.js";
import { random_embed_color } from "../../util/random_embed_color.js";
const reward_boosters = config.server.roles.reward_boosters;
export async function add_currency(user_id, currency_name, amount, reason) {
    const user_currency_amount = await get_currency_balance(user_id, currency_name);
    const new_amount = user_currency_amount + amount;
    if (new_amount < 0 &&
        !(await get_currency_config(currency_name)).can_be_negative)
        throw new Error("This currency cannot be negative");
    await db.run(SQL `UPDATE user_currencies SET amount = ${user_currency_amount + amount} WHERE user_id = ${user_id} AND currency_id = ${currency_name}`);
    if (reason) {
        const econlogs = client.channels.resolve(config.server.channels.econlogs);
        econlogs.send({
            embeds: [
                new Discord.EmbedBuilder()
                    .setColor(random_embed_color())
                    .setTitle(`${amount} ${currency_name} added to ${client.users.resolve(user_id).displayName}`)
                    .setDescription(`${reason ? `Reason: ${reason}` : `No reason specified`}`),
            ],
        });
    }
}
export async function get_currency_balance(user_id, currency_id) {
    if (currency_id) {
        if (!(await does_currency_exist(currency_id)))
            throw new Error("Currency does not exist");
        const data = await db.get(SQL `SELECT currency_id, amount FROM user_currencies WHERE user_id = ${user_id} AND currency_id = ${currency_id}`);
        if (data == undefined) {
            await db.run(SQL `INSERT INTO user_currencies (user_id, currency_id, amount) VALUES (${user_id}, ${currency_id}, 0)`);
            return 0;
        }
        return data.amount;
    }
    else {
        const data = (await db.all(SQL `SELECT currency_id, amount FROM user_currencies WHERE user_id = ${user_id}`)) || [];
        let user_currency_amounts = {};
        for (let row of data)
            user_currency_amounts[row.currency_id] = row.amount;
        let currency_row = await db.get(`SELECT group_concat(currency_id) AS list FROM currency_config`);
        const currency_list = currency_row.list;
        for (let currency of currency_list.split(",")) {
            if (!user_currency_amounts[currency])
                user_currency_amounts[currency] = 0;
        }
        return user_currency_amounts;
    }
}
export async function reset_currency(currency_name) {
    if (!(await does_currency_exist(currency_name)))
        throw new Error("Currency does not exist");
    await db.run(SQL `UPDATE user_currencies SET amount = 0 WHERE currency_id = ${currency_name}`);
}
export async function autogive_message(user_id) {
    const currencies = await db.all(`SELECT * FROM currency_config WHERE message_auto_give IS NOT NULL`);
    for (let currency of currencies)
        await add_currency(user_id, currency.currency_id, currency.message_auto_give);
}
export async function add_user_xp(user_id, amount_to_add, levelup_channel) {
    const balances = await get_currency_balance(user_id);
    const new_xp = balances.xp + amount_to_add;
    await add_currency(user_id, "xp", amount_to_add);
    if (levelups.first_message.checker(balances.xp, balances.prestige, balances.superprestige)) {
        levelups.first_message.process(user_id, levelup_channel);
    }
    if (levelups.xp_system.checker(balances.xp, new_xp))
        await levelups.xp_system.process(new_xp, user_id, levelup_channel);
}
export async function purge_member_currencies(user_id) {
    await db.all(SQL `DELETE FROM user_currencies WHERE user_id = ${user_id}`);
    await db.all(SQL `DELETE FROM xp_boosts WHERE owner_id = ${user_id}`);
    return;
}
export async function get_user_xp_multiplier(user_id, channel_id) {
    const user_boosts = await db.all(SQL `SELECT multiplier FROM xp_boosts WHERE owner_id = ${user_id} AND end_timestamp > ${Date.now()}`);
    if (!user_boosts[0])
        return 1;
    const user_boost_multipliers = user_boosts.map((boost) => boost.multiplier);
    let user_boost_total = user_boost_multipliers.reduce((total, boost) => total * boost);
    if (channel_id) {
        if (config.server.leveling.modified_xp_channels
            .map(([id]) => id)
            .includes(channel_id))
            user_boost_total *= config.server.leveling.modified_xp_channels.find(([id]) => id === channel_id)[1];
    }
    const user_boosting = client.guilds
        .resolve(config.server.id)
        .members.resolve(user_id).premiumSince
        ? true
        : false;
    let max_user_boost_total = config.server.leveling.max_xp_boost_multipliers.default;
    if (user_boosting)
        max_user_boost_total =
            config.server.leveling.max_xp_boost_multipliers.boosters;
    return Math.min(user_boost_total, max_user_boost_total);
}
export async function give_reward(user_id, messages) {
    const { xp_boost_multiplier, xp_boost_duration, currency_to_give, currency_to_give_amount, role_id, } = await db.get(SQL `SELECT * from rewards WHERE messages = ${messages}`);
    const guild = client.guilds.resolve(config.server.id);
    const member = guild.members.resolve(user_id);
    let reward_multiplier = 1;
    for (let [id, badge_multiplier] of Object.entries(reward_boosters)) {
        if (member.roles.cache.has(id) && badge_multiplier > reward_multiplier)
            reward_multiplier = badge_multiplier;
    }
    if (currency_to_give && currency_to_give_amount)
        await add_currency(user_id, currency_to_give, Math.round(currency_to_give_amount));
    if (role_id)
        member.roles.add(role_id);
    if (xp_boost_duration && xp_boost_multiplier) {
        const boost_to_extend = await db.get(SQL `SELECT * from xp_boosts WHERE multiplier = ${xp_boost_multiplier} AND owner_id = ${user_id}`);
        if (boost_to_extend)
            extend_xp_boost({
                id: boost_to_extend.id,
                extend_ms: xp_boost_duration * reward_multiplier,
            });
        else
            generate_xp_boost({
                owner_id: user_id,
                multiplier: xp_boost_multiplier,
                unclaimed_time_ms: Math.round(xp_boost_duration * reward_multiplier),
            });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXJpdGhtZXRpYy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jdXJyZW5jeS9vcGVyYXRpb25zL2FyaXRobWV0aWMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxHQUFHLE1BQU0sc0JBQXNCLENBQUM7QUFDdkMsT0FBTyxFQUFFLEVBQUUsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3pDLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQy9ELE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBQ25FLE9BQU8sS0FBSyxPQUFPLE1BQU0sWUFBWSxDQUFDO0FBQ3RDLE9BQU8sS0FBSyxRQUFRLE1BQU0sdUNBQXVDLENBQUM7QUFDbEUsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQ2pELE9BQU8sTUFBTSxNQUFNLDJCQUEyQixDQUFDLFNBQVMsSUFBSSxFQUFFLE1BQU0sRUFBRSxDQUFDO0FBQ3ZFLE9BQU8sRUFDTCxlQUFlLEVBQ2YsaUJBQWlCLEdBQ2xCLE1BQU0sNkJBQTZCLENBQUM7QUFDckMsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFDdEUsTUFBTSxlQUFlLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsZUFBZSxDQUFDO0FBRTVELE1BQU0sQ0FBQyxLQUFLLFVBQVUsWUFBWSxDQUNoQyxPQUFlLEVBQ2YsYUFBcUIsRUFDckIsTUFBYyxFQUNkLE1BQWU7SUFFZixNQUFNLG9CQUFvQixHQUFHLE1BQU0sb0JBQW9CLENBQ3JELE9BQU8sRUFDUCxhQUFhLENBQ2QsQ0FBQztJQUNGLE1BQU0sVUFBVSxHQUFHLG9CQUFvQixHQUFHLE1BQU0sQ0FBQztJQUNqRCxJQUNFLFVBQVUsR0FBRyxDQUFDO1FBQ2QsQ0FBQyxDQUFDLE1BQU0sbUJBQW1CLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FB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QUFJLGdCQUFnQixHQUFHLGlCQUFpQjtZQUNwRSxpQkFBaUIsR0FBRyxnQkFBZ0IsQ0FBQztJQUN6QyxDQUFDO0lBR0QsSUFBSSxnQkFBZ0IsSUFBSSx1QkFBdUI7UUFDN0MsTUFBTSxZQUFZLENBQ2hCLE9BQU8sRUFDUCxnQkFBZ0IsRUFDaEIsSUFBSSxDQUFDLEtBQUssQ0FBQyx1QkFBdUIsQ0FBQyxDQUNwQyxDQUFDO0lBQ0osSUFBSSxPQUFPO1FBQUUsTUFBTSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDdkMsSUFBSSxpQkFBaUIsSUFBSSxtQkFBbUIsRUFBRSxDQUFDO1FBQzdDLE1BQU0sZUFBZSxHQUFHLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FDbEMsR0FBRyxDQUFBLDhDQUE4QyxtQkFBbUIsbUJBQW1CLE9BQU8sRUFBRSxDQUNqRyxDQUFDO1FBQ0YsSUFBSSxlQUFlO1lBQ2pCLGVBQWUsQ0FBQztnQkFDZCxFQUFFLEVBQUUsZUFBZSxDQUFDLEVBQUU7Z0JBQ3RCLFNBQVMsRUFBRSxpQkFBaUIsR0FBRyxpQkFBaUI7YUFDakQsQ0FBQyxDQUFDOztZQUVILGlCQUFpQixDQUFDO2dCQUNoQixRQUFRLEVBQUUsT0FBTztnQkFDakIsVUFBVSxFQUFFLG1CQUFtQjtnQkFDL0IsaUJBQWlCLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxpQkFBaUIsR0FBRyxpQkFBaUIsQ0FBQzthQUNyRSxDQUFDLENBQUM7SUFDUCxDQUFDO0FBQ0gsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBTUUwgZnJvbSBcInNxbC10ZW1wbGF0ZS1zdHJpbmdzXCI7XHJcbmltcG9ydCB7IGRiIH0gZnJvbSBcIi4uLy4uL3N0YXJ0dXAvZGIuanNcIjtcclxuaW1wb3J0IHsgZG9lc19jdXJyZW5jeV9leGlzdCB9IGZyb20gXCIuL2RvZXNfY3VycmVuY3lfZXhpc3QuanNcIjtcclxuaW1wb3J0IHsgZ2V0X2N1cnJlbmN5X2NvbmZpZyB9IGZyb20gXCIuLi9jb25maWd1cmVycy9jdXJyZW5jaWVzLmpzXCI7XHJcbmltcG9ydCAqIGFzIERpc2NvcmQgZnJvbSBcImRpc2NvcmQuanNcIjtcclxuaW1wb3J0ICogYXMgbGV2ZWx1cHMgZnJvbSBcIi4uLy4uL2N1cnJlbmN5L29wZXJhdGlvbnMvbGV2ZWx1cHMuanNcIjtcclxuaW1wb3J0IHsgY2xpZW50IH0gZnJvbSBcIi4uLy4uL3N0YXJ0dXAvY2xpZW50LmpzXCI7XHJcbmltcG9ydCBjb25maWcgZnJvbSBcIi4uLy4uL2NvbmZpZ3MvY29uZmlnLmpzb25cIiBhc3NlcnQgeyB0eXBlOiBcImpzb25cIiB9O1xyXG5pbXBvcnQge1xyXG4gIGV4dGVuZF94cF9ib29zdCxcclxuICBnZW5lcmF0ZV94cF9ib29zdCxcclxufSBmcm9tIFwiLi4vY29uZmlndXJlcnMveHBfYm9vc3RzLmpzXCI7XHJcbmltcG9ydCB7IHJhbmRvbV9lbWJlZF9jb2xvciB9IGZyb20gXCIuLi8uLi91dGlsL3JhbmRvbV9lbWJlZF9jb2xvci5qc1wiO1xyXG5jb25zdCByZXdhcmRfYm9vc3RlcnMgPSBjb25maWcuc2VydmVyLnJvbGVzLnJld2FyZF9ib29zdGVycztcclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBhZGRfY3VycmVuY3koXHJcbiAgdXNlcl9pZDogc3RyaW5nLFxyXG4gIGN1cnJlbmN5X25hbWU6IHN0cmluZyxcclxuICBhbW91bnQ6IG51bWJlcixcclxuICByZWFzb24/OiBzdHJpbmdcclxuKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgY29uc3QgdXNlcl9jdXJyZW5jeV9hbW91bnQgPSBhd2FpdCBnZXRfY3VycmVuY3lfYmFsYW5jZShcclxuICAgIHVzZXJfaWQsXHJcbiAgICBjdXJyZW5jeV9uYW1lXHJcbiAgKTtcclxuICBjb25zdCBuZXdfYW1vdW50ID0gdXNlcl9jdXJyZW5jeV9hbW91bnQgKyBhbW91bnQ7XHJcbiAgaWYgKFxyXG4gICAgbmV3X2Ftb3VudCA8IDAgJiZcclxuICAgICEoYXdhaXQgZ2V0X2N1cnJlbmN5X2NvbmZpZyhjdXJyZW5jeV9uYW1lKSkuY2FuX2JlX25lZ2F0aXZlXHJcbiAgKVxyXG4gICAgdGhyb3cgbmV3IEVycm9yKFwiVGhpcyBjdXJyZW5jeSBjYW5ub3QgYmUgbmVnYXRpdmVcIik7XHJcbiAgYXdhaXQgZGIucnVuKFxyXG4gICAgU1FMYFVQREFURSB1c2VyX2N1cnJlbmNpZXMgU0VUIGFtb3VudCA9ICR7XHJcbiAgICAgIHVzZXJfY3VycmVuY3lfYW1vdW50ICsgYW1vdW50XHJcbiAgICB9IFdIRVJFIHVzZXJfaWQgPSAke3VzZXJfaWR9IEFORCBjdXJyZW5jeV9pZCA9ICR7Y3VycmVuY3lfbmFtZX1gXHJcbiAgKTtcclxuICBpZiAocmVhc29uKSB7XHJcbiAgICBjb25zdCBlY29ubG9ncyA9IGNsaWVudC5jaGFubmVscy5yZXNvbHZlKFxyXG4gICAgICBjb25maWcuc2VydmVyLmNoYW5uZWxzLmVjb25sb2dzXHJcbiAgICApIGFzIERpc2NvcmQuVGV4dENoYW5uZWw7XHJcbiAgICBlY29ubG9ncy5zZW5kKHtcclxuICAgICAgZW1iZWRzOiBbXHJcbiAgICAgICAgbmV3IERpc2NvcmQuRW1iZWRCdWlsZGVyKClcclxuICAgICAgICAgIC5zZXRDb2xvcihyYW5kb21fZW1iZWRfY29sb3IoKSlcclxuICAgICAgICAgIC5zZXRUaXRsZShcclxuICAgICAgICAgICAgYCR7YW1vdW50fSAke2N1cnJlbmN5X25hbWV9IGFkZGVkIHRvICR7XHJcbiAgICAgICAgICAgICAgY2xpZW50LnVzZXJzLnJlc29sdmUodXNlcl9pZCkuZGlzcGxheU5hbWVcclxuICAgICAgICAgICAgfWBcclxuICAgICAgICAgIClcclxuICAgICAgICAgIC5zZXREZXNjcmlwdGlvbihcclxuICAgICAgICAgICAgYCR7cmVhc29uID8gYFJlYXNvbjogJHtyZWFzb259YCA6IGBObyByZWFzb24gc3BlY2lmaWVkYH1gXHJcbiAgICAgICAgICApLFxyXG4gICAgICBdLFxyXG4gICAgfSk7XHJcbiAgfVxyXG59XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0X2N1cnJlbmN5X2JhbGFuY2UoXHJcbiAgdXNlcl9pZDogc3RyaW5nLFxyXG4gIGN1cnJlbmN5X2lkPzogc3RyaW5nXHJcbik6IFByb21pc2U8YW55PiB7XHJcbiAgaWYgKGN1cnJlbmN5X2lkKSB7XHJcbiAgICBpZiAoIShhd2FpdCBkb2VzX2N1cnJlbmN5X2V4aXN0KGN1cnJlbmN5X2lkKSkpXHJcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkN1cnJlbmN5IGRvZXMgbm90IGV4aXN0XCIpO1xyXG4gICAgY29uc3QgZGF0YSA9IGF3YWl0IGRiLmdldChcclxuICAgICAgU1FMYFNFTEVDVCBjdXJyZW5jeV9pZCwgYW1vdW50IEZST00gdXNlcl9jdXJyZW5jaWVzIFdIRVJFIHVzZXJfaWQgPSAke3VzZXJfaWR9IEFORCBjdXJyZW5jeV9pZCA9ICR7Y3VycmVuY3lfaWR9YFxyXG4gICAgKTtcclxuICAgIGlmIChkYXRhID09IHVuZGVmaW5lZCkge1xyXG4gICAgICBhd2FpdCBkYi5ydW4oXHJcbiAgICAgICAgU1FMYElOU0VSVCBJTlRPIHVzZXJfY3VycmVuY2llcyAodXNlcl9pZCwgY3VycmVuY3lfaWQsIGFtb3VudCkgVkFMVUVTICgke3VzZXJfaWR9LCAke2N1cnJlbmN5X2lkfSwgMClgXHJcbiAgICAgICk7XHJcbiAgICAgIHJldHVybiAwO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGRhdGEuYW1vdW50O1xyXG4gIH0gZWxzZSB7XHJcbiAgICBjb25zdCBkYXRhID1cclxuICAgICAgKGF3YWl0IGRiLmFsbChcclxuICAgICAgICBTUUxgU0VMRUNUIGN1cnJlbmN5X2lkLCBhbW91bnQgRlJPTSB1c2VyX2N1cnJlbmNpZXMgV0hFUkUgdXNlcl9pZCA9ICR7dXNlcl9pZH1gXHJcbiAgICAgICkpIHx8IFtdO1xyXG4gICAgbGV0IHVzZXJfY3VycmVuY3lfYW1vdW50cyA9IHt9O1xyXG4gICAgZm9yIChsZXQgcm93IG9mIGRhdGEpIHVzZXJfY3VycmVuY3lfYW1vdW50c1tyb3cuY3VycmVuY3lfaWRdID0gcm93LmFtb3VudDtcclxuICAgIC8vIEZpbGwgaW4gZGF0YSBmb3IgYW55IGN1cnJlbmN5IGRhdGEgdGhlIHVzZXIgaXMgbWlzc2luZ1xyXG4gICAgbGV0IGN1cnJlbmN5X3JvdyA9IGF3YWl0IGRiLmdldChcclxuICAgICAgYFNFTEVDVCBncm91cF9jb25jYXQoY3VycmVuY3lfaWQpIEFTIGxpc3QgRlJPTSBjdXJyZW5jeV9jb25maWdgXHJcbiAgICApO1xyXG4gICAgY29uc3QgY3VycmVuY3lfbGlzdCA9IGN1cnJlbmN5X3Jvdy5saXN0O1xyXG4gICAgZm9yIChsZXQgY3VycmVuY3kgb2YgY3VycmVuY3lfbGlzdC5zcGxpdChcIixcIikpIHtcclxuICAgICAgaWYgKCF1c2VyX2N1cnJlbmN5X2Ftb3VudHNbY3VycmVuY3ldKSB1c2VyX2N1cnJlbmN5X2Ftb3VudHNbY3VycmVuY3ldID0gMDtcclxuICAgIH1cclxuICAgIHJldHVybiB1c2VyX2N1cnJlbmN5X2Ftb3VudHM7XHJcbiAgfVxyXG59XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcmVzZXRfY3VycmVuY3koY3VycmVuY3lfbmFtZTogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgaWYgKCEoYXdhaXQgZG9lc19jdXJyZW5jeV9leGlzdChjdXJyZW5jeV9uYW1lKSkpXHJcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJDdXJyZW5jeSBkb2VzIG5vdCBleGlzdFwiKTtcclxuICBhd2FpdCBkYi5ydW4oXHJcbiAgICBTUUxgVVBEQVRFIHVzZXJfY3VycmVuY2llcyBTRVQgYW1vdW50ID0gMCBXSEVSRSBjdXJyZW5jeV9pZCA9ICR7Y3VycmVuY3lfbmFtZX1gXHJcbiAgKTtcclxufVxyXG5cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGF1dG9naXZlX21lc3NhZ2UodXNlcl9pZDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgLy8gUXVlcnkgY3VycmVuY3lfY29uZmlnIGZvciBhbGwgY3VycmVuY2llcyB3aXRoIG1lc3NhZ2VfYXV0b19naXZlICE9IHVuZGVmaW5lZFxyXG4gIGNvbnN0IGN1cnJlbmNpZXMgPSBhd2FpdCBkYi5hbGwoXHJcbiAgICBgU0VMRUNUICogRlJPTSBjdXJyZW5jeV9jb25maWcgV0hFUkUgbWVzc2FnZV9hdXRvX2dpdmUgSVMgTk9UIE5VTExgXHJcbiAgKTtcclxuICBmb3IgKGxldCBjdXJyZW5jeSBvZiBjdXJyZW5jaWVzKVxyXG4gICAgYXdhaXQgYWRkX2N1cnJlbmN5KFxyXG4gICAgICB1c2VyX2lkLFxyXG4gICAgICBjdXJyZW5jeS5jdXJyZW5jeV9pZCxcclxuICAgICAgY3VycmVuY3kubWVzc2FnZV9hdXRvX2dpdmVcclxuICAgICk7XHJcbn1cclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBhZGRfdXNlcl94cChcclxuICB1c2VyX2lkOiBzdHJpbmcsXHJcbiAgYW1vdW50X3RvX2FkZDogbnVtYmVyLFxyXG4gIGxldmVsdXBfY2hhbm5lbDogRGlzY29yZC5UZXh0QmFzZWRDaGFubmVsXHJcbikge1xyXG4gIGNvbnN0IGJhbGFuY2VzID0gYXdhaXQgZ2V0X2N1cnJlbmN5X2JhbGFuY2UodXNlcl9pZCk7XHJcbiAgY29uc3QgbmV3X3hwID0gYmFsYW5jZXMueHAgKyBhbW91bnRfdG9fYWRkO1xyXG4gIGF3YWl0IGFkZF9jdXJyZW5jeSh1c2VyX2lkLCBcInhwXCIsIGFtb3VudF90b19hZGQpO1xyXG4gIGlmIChcclxuICAgIGxldmVsdXBzLmZpcnN0X21lc3NhZ2UuY2hlY2tlcihcclxuICAgICAgYmFsYW5jZXMueHAsXHJcbiAgICAgIGJhbGFuY2VzLnByZXN0aWdlLFxyXG4gICAgICBiYWxhbmNlcy5zdXBlcnByZXN0aWdlXHJcbiAgICApXHJcbiAgKSB7XHJcbiAgICBsZXZlbHVwcy5maXJzdF9tZXNzYWdlLnByb2Nlc3ModXNlcl9pZCwgbGV2ZWx1cF9jaGFubmVsKTtcclxuICB9XHJcbiAgaWYgKGxldmVsdXBzLnhwX3N5c3RlbS5jaGVja2VyKGJhbGFuY2VzLnhwLCBuZXdfeHApKVxyXG4gICAgYXdhaXQgbGV2ZWx1cHMueHBfc3lzdGVtLnByb2Nlc3MobmV3X3hwLCB1c2VyX2lkLCBsZXZlbHVwX2NoYW5uZWwpO1xyXG59XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcHVyZ2VfbWVtYmVyX2N1cnJlbmNpZXModXNlcl9pZDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgYXdhaXQgZGIuYWxsKFNRTGBERUxFVEUgRlJPTSB1c2VyX2N1cnJlbmNpZXMgV0hFUkUgdXNlcl9pZCA9ICR7dXNlcl9pZH1gKTtcclxuICBhd2FpdCBkYi5hbGwoU1FMYERFTEVURSBGUk9NIHhwX2Jvb3N0cyBXSEVSRSBvd25lcl9pZCA9ICR7dXNlcl9pZH1gKTtcclxuICByZXR1cm47XHJcbn1cclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRfdXNlcl94cF9tdWx0aXBsaWVyKFxyXG4gIHVzZXJfaWQ6IHN0cmluZyxcclxuICBjaGFubmVsX2lkPzogc3RyaW5nXHJcbikge1xyXG4gIGNvbnN0IHVzZXJfYm9vc3RzID0gYXdhaXQgZGIuYWxsKFxyXG4gICAgU1FMYFNFTEVDVCBtdWx0aXBsaWVyIEZST00geHBfYm9vc3RzIFdIRVJFIG93bmVyX2lkID0gJHt1c2VyX2lkfSBBTkQgZW5kX3RpbWVzdGFtcCA+ICR7RGF0ZS5ub3coKX1gXHJcbiAgKTtcclxuICBpZiAoIXVzZXJfYm9vc3RzWzBdKSByZXR1cm4gMTtcclxuICBjb25zdCB1c2VyX2Jvb3N0X211bHRpcGxpZXJzID0gdXNlcl9ib29zdHMubWFwKChib29zdCkgPT4gYm9vc3QubXVsdGlwbGllcik7XHJcbiAgbGV0IHVzZXJfYm9vc3RfdG90YWwgPSB1c2VyX2Jvb3N0X211bHRpcGxpZXJzLnJlZHVjZShcclxuICAgICh0b3RhbCwgYm9vc3QpID0+IHRvdGFsICogYm9vc3RcclxuICApO1xyXG4gIGlmIChjaGFubmVsX2lkKSB7XHJcbiAgICBpZiAoXHJcbiAgICAgIGNvbmZpZy5zZXJ2ZXIubGV2ZWxpbmcubW9kaWZpZWRfeHBfY2hhbm5lbHNcclxuICAgICAgICAubWFwKChbaWRdKSA9PiBpZClcclxuICAgICAgICAuaW5jbHVkZXMoY2hhbm5lbF9pZClcclxuICAgIClcclxuICAgICAgdXNlcl9ib29zdF90b3RhbCAqPSBjb25maWcuc2VydmVyLmxldmVsaW5nLm1vZGlmaWVkX3hwX2NoYW5uZWxzLmZpbmQoXHJcbiAgICAgICAgKFtpZF0pID0+IGlkID09PSBjaGFubmVsX2lkXHJcbiAgICAgIClbMV0gYXMgbnVtYmVyO1xyXG4gIH1cclxuICBjb25zdCB1c2VyX2Jvb3N0aW5nID0gY2xpZW50Lmd1aWxkc1xyXG4gICAgLnJlc29sdmUoY29uZmlnLnNlcnZlci5pZClcclxuICAgIC5tZW1iZXJzLnJlc29sdmUodXNlcl9pZCkucHJlbWl1bVNpbmNlXHJcbiAgICA/IHRydWVcclxuICAgIDogZmFsc2U7XHJcbiAgbGV0IG1heF91c2VyX2Jvb3N0X3RvdGFsID1cclxuICAgIGNvbmZpZy5zZXJ2ZXIubGV2ZWxpbmcubWF4X3hwX2Jvb3N0X211bHRpcGxpZXJzLmRlZmF1bHQ7XHJcbiAgaWYgKHVzZXJfYm9vc3RpbmcpXHJcbiAgICBtYXhfdXNlcl9ib29zdF90b3RhbCA9XHJcbiAgICAgIGNvbmZpZy5zZXJ2ZXIubGV2ZWxpbmcubWF4X3hwX2Jvb3N0X211bHRpcGxpZXJzLmJvb3N0ZXJzO1xyXG4gIHJldHVybiBNYXRoLm1pbih1c2VyX2Jvb3N0X3RvdGFsLCBtYXhfdXNlcl9ib29zdF90b3RhbCk7XHJcbn1cclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnaXZlX3Jld2FyZCh1c2VyX2lkOiBzdHJpbmcsIG1lc3NhZ2VzOiBudW1iZXIpIHtcclxuICAvLyBHZXQgcmV3YXJkICYgbWVtYmVyXHJcbiAgY29uc3Qge1xyXG4gICAgeHBfYm9vc3RfbXVsdGlwbGllcixcclxuICAgIHhwX2Jvb3N0X2R1cmF0aW9uLFxyXG4gICAgY3VycmVuY3lfdG9fZ2l2ZSxcclxuICAgIGN1cnJlbmN5X3RvX2dpdmVfYW1vdW50LFxyXG4gICAgcm9sZV9pZCxcclxuICB9ID0gYXdhaXQgZGIuZ2V0KFNRTGBTRUxFQ1QgKiBmcm9tIHJld2FyZHMgV0hFUkUgbWVzc2FnZXMgPSAke21lc3NhZ2VzfWApO1xyXG4gIGNvbnN0IGd1aWxkID0gY2xpZW50Lmd1aWxkcy5yZXNvbHZlKGNvbmZpZy5zZXJ2ZXIuaWQpO1xyXG4gIGNvbnN0IG1lbWJlciA9IGd1aWxkLm1lbWJlcnMucmVzb2x2ZSh1c2VyX2lkKTtcclxuXHJcbiAgLy8gQ2FsY3VsYXRlIHJld2FyZCBtdWx0aXBsaWVyXHJcbiAgbGV0IHJld2FyZF9tdWx0aXBsaWVyID0gMTtcclxuICBmb3IgKGxldCBbaWQsIGJhZGdlX211bHRpcGxpZXJdIG9mIE9iamVjdC5lbnRyaWVzKHJld2FyZF9ib29zdGVycykpIHtcclxuICAgIGlmIChtZW1iZXIucm9sZXMuY2FjaGUuaGFzKGlkKSAmJiBiYWRnZV9tdWx0aXBsaWVyID4gcmV3YXJkX211bHRpcGxpZXIpXHJcbiAgICAgIHJld2FyZF9tdWx0aXBsaWVyID0gYmFkZ2VfbXVsdGlwbGllcjtcclxuICB9XHJcblxyXG4gIC8vIERpc3BlbnNlIHJld2FyZFxyXG4gIGlmIChjdXJyZW5jeV90b19naXZlICYmIGN1cnJlbmN5X3RvX2dpdmVfYW1vdW50KVxyXG4gICAgYXdhaXQgYWRkX2N1cnJlbmN5KFxyXG4gICAgICB1c2VyX2lkLFxyXG4gICAgICBjdXJyZW5jeV90b19naXZlLFxyXG4gICAgICBNYXRoLnJvdW5kKGN1cnJlbmN5X3RvX2dpdmVfYW1vdW50KVxyXG4gICAgKTtcclxuICBpZiAocm9sZV9pZCkgbWVtYmVyLnJvbGVzLmFkZChyb2xlX2lkKTtcclxuICBpZiAoeHBfYm9vc3RfZHVyYXRpb24gJiYgeHBfYm9vc3RfbXVsdGlwbGllcikge1xyXG4gICAgY29uc3QgYm9vc3RfdG9fZXh0ZW5kID0gYXdhaXQgZGIuZ2V0KFxyXG4gICAgICBTUUxgU0VMRUNUICogZnJvbSB4cF9ib29zdHMgV0hFUkUgbXVsdGlwbGllciA9ICR7eHBfYm9vc3RfbXVsdGlwbGllcn0gQU5EIG93bmVyX2lkID0gJHt1c2VyX2lkfWBcclxuICAgICk7XHJcbiAgICBpZiAoYm9vc3RfdG9fZXh0ZW5kKVxyXG4gICAgICBleHRlbmRfeHBfYm9vc3Qoe1xyXG4gICAgICAgIGlkOiBib29zdF90b19leHRlbmQuaWQsXHJcbiAgICAgICAgZXh0ZW5kX21zOiB4cF9ib29zdF9kdXJhdGlvbiAqIHJld2FyZF9tdWx0aXBsaWVyLFxyXG4gICAgICB9KTtcclxuICAgIGVsc2VcclxuICAgICAgZ2VuZXJhdGVfeHBfYm9vc3Qoe1xyXG4gICAgICAgIG93bmVyX2lkOiB1c2VyX2lkLFxyXG4gICAgICAgIG11bHRpcGxpZXI6IHhwX2Jvb3N0X211bHRpcGxpZXIsXHJcbiAgICAgICAgdW5jbGFpbWVkX3RpbWVfbXM6IE1hdGgucm91bmQoeHBfYm9vc3RfZHVyYXRpb24gKiByZXdhcmRfbXVsdGlwbGllciksXHJcbiAgICAgIH0pO1xyXG4gIH1cclxufVxyXG4iXX0=